---
- name: Performing Linux OS Patching
  hosts: "{{ NODES }}"
  # give NODES during playbook -> -e "NODES=mynodes"
  become: true
  
  vars:
    email_notificaiton: false
    email_to_address: app-owners@lab.local
    
    ## service list - it can be stored in inventory level as well
    service_list:
      - nginx
      - mysqld
      - httpd

  tasks:
    - name: "Pre-Task: Sending Email to Server and App Owners"
      include_role:
        name: send-email
      vars:
        email_subject: 'OS patching is beginning now'
      when: email_notificaiton is true
      tags: pretaskemail
    
    - name: "Patching Pre-tasks"
      include_role:
        name: linux-patching
        tasks_from: linux-patching-pre-tasks.yaml
    
    - name: "Patching Tasks"
      include_role:
        name: linux-patching

    - name: "Patching Post-tasks"
      include_role:
        name: linux-patching
        tasks_from: linux-patching-post-tasks.yaml

    - name: "Pre-Task: Sending Email to Server and App Owners"
      include_role:
        name: send-email
      vars:
        email_subject: 'OS patching has been completed'
      when: email_notificaiton is true
      tags: 
        - posttaskemail